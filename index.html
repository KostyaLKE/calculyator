<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Калькулятор + Таймер</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      display: flex; 
      height: 100vh; 
      justify-content: center; 
      align-items: center;
      background: #eef2f7; 
      font-family: 'Segoe UI', Tahoma, sans-serif; 
      transition: background 0.3s;
    }
    body.dark { background: #333; }
    .calculator { 
      background: #fff; 
      border-radius: 12px; 
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      padding: 20px; 
      width: 320px; 
      text-align: center; 
      transition: background 0.3s;
    }
    .calculator.dark { background: #444; color: #fff; }
    h2 { color: #333; font-weight: 500; margin-bottom: 12px; }
    .calculator.dark h2 { color: #fff; }
    input, select { 
      padding: 10px; 
      margin: 5px 0; 
      border: 1px solid #ccd0d5;
      border-radius: 6px; 
      font-size: 14px; 
      width: 100%; 
      transition: border-color 0.3s;
    }
    .calculator.dark input, .calculator.dark select { 
      background: #555; 
      color: #fff; 
      border-color: #666; 
    }
    input.invalid { border-color: red; }
    button { 
      padding: 8px; 
      margin: 12px 4px; 
      border: none; 
      color: #fff; 
      font-size: 14px;
      border-radius: 6px; 
      cursor: pointer; 
      transition: background 0.3s, transform 0.1s; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      gap: 8px;
    }
    button:active { transform: scale(0.95); }
    #calcBtn { 
      background: #4a90e2; 
      width: 100%; 
    } 
    #calcBtn:hover { background: #357ab8; }
    #openTiny, #toggleTheme, #clearHistory { 
      background: #7f8c8d; 
      width: calc(33.33% - 8px); 
      height: 36px; 
      padding: 6px; 
    }
    #openTiny:hover, #toggleTheme:hover, #clearHistory:hover { 
      background: #6c7a89; 
    }
    #timerBtn, #resetTimerBtn { 
      background: #f39c12; 
      width: calc(50% - 8px); 
    }
    #timerBtn:hover, #resetTimerBtn:hover { 
      background: #d77b0c; 
    }
    #resetTimerBtn { background: #e74c3c; } 
    #resetTimerBtn:hover { background: #c0392b; }
    .button-group { 
      display: flex; 
      justify-content: space-between; 
      flex-wrap: nowrap; 
      align-items: center;
    }
    .timer-button-group { 
      display: flex; 
      justify-content: space-between; 
      flex-wrap: nowrap; 
      align-items: center;
      margin-top: 10px;
    }
    .result { 
      margin-top: 10px; 
      font-size: 16px; 
      min-height: 20px; 
      color: #222; 
      background: #f0f4f8;
      border: 1px solid #ccd0d5;
      border-radius: 6px;
      padding: 8px;
    }
    .calculator.dark .result { 
      color: #fff; 
      background: #555; 
      border-color: #666; 
    }
    .history { 
      text-align: left; 
      max-height: 100px; 
      overflow-y: auto; 
      margin: 8px 0; 
      padding: 4px;
      border: 1px solid #ddd; 
      border-radius: 6px; 
      background: #fafafa; 
      font-size: 12px; 
      opacity: 0.85;
    }
    .calculator.dark .history { 
      background: #555; 
      border-color: #666; 
    }
    .history-item { margin-bottom: 3px; }
    .timer-block { 
      display: flex; 
      justify-content: space-between; 
      margin-top: 10px; 
    }
    .timer-block input { width: 48%; }
    .timer-display { 
      margin-top: 10px; 
      font-size: 22px; 
      color: green; 
      font-weight: bold; 
    }
    .timer-display.ending { color: red; }
    .progress-bar {
      height: 10px;
      background: #ddd;
      border-radius: 5px;
      margin-top: 10px;
      overflow: hidden;
    }
    .calculator.dark .progress-bar { background: #666; }
    .progress-bar::before {
      content: '';
      display: block;
      height: 100%;
      background: #4a90e2;
      width: var(--progress, 0);
      transition: width 1s linear;
    }
    [title]:hover:after {
      content: attr(title);
      position: absolute;
      background: #333;
      color: #fff;
      padding: 5px;
      border-radius: 4px;
      font-size: 12px;
      z-index: 10;
    }
    @media (max-width: 400px) {
      .calculator { width: 90%; padding: 15px; }
      input, select, button { font-size: 12px; }
      #openTiny, #toggleTheme, #clearHistory { 
        width: calc(33.33% - 6px); 
        height: 32px; 
        padding: 5px; 
      }
      #timerBtn, #resetTimerBtn { width: calc(50% - 6px); }
    }
  </style>
</head>
<body>

<div class="calculator">
  <select id="mode" title="Выберите режим расчета">
    <option value="percentOfNumber">X% от числа Y?</option>
    <option value="numberIsPercent">X — сколько % от Y?</option>
    <option value="numberFromPercent" selected>X% от какого числа Y?</option>
    <option value="increaseByPercent">Увеличить Y на X%</option>
  </select>
  <input type="number" id="xInput" placeholder="Процент (X)" title="Введите процентное значение (X)" />
  <input type="number" id="yInput" placeholder="Результат (Y)" title="Введите число или результат (Y)" />
  <button id="calcBtn"><i class="fas fa-calculator"></i> Рассчитать</button>
  <div class="result" id="result"></div>
  <div class="history" id="history"></div>
  <div class="button-group">
    <button id="clearHistory" title="Очистить историю"><i class="fas fa-trash"></i></button>
    <button id="openTiny" title="Открыть компактное окно"><i class="fas fa-window-restore"></i></button>
    <button id="toggleTheme" title="Переключить тему"><i class="fas fa-moon"></i></button>
  </div>
  <div class="timer-block">
    <input type="number" id="minInput" placeholder="Мин" title="Введите минуты" />
    <input type="number" id="secInput" placeholder="Сек" title="Введите секунды" />
  </div>
  <div class="timer-button-group">
    <button id="timerBtn"><i class="fas fa-clock"></i> <span>Start Timer</span></button>
    <button id="resetTimerBtn"><i class="fas fa-undo"></i> <span>Reset Timer</span></button>
  </div>
  <div class="timer-display" id="timerDisplay">00:00</div>
  <div class="progress-bar" id="progressBar"></div>
  <audio id="beep" preload="auto">
    <source src="https://www.soundjay.com/buttons/beep-01a.mp3" type="audio/mpeg">
    <source src="https://www.soundjay.com/buttons/beep-01a.ogg" type="audio/ogg">
  </audio>
</div>

<script>
  // ————— Калькулятор + История —————
  const modeEl = document.getElementById('mode'),
        xEl = document.getElementById('xInput'),
        yEl = document.getElementById('yInput'),
        btn = document.getElementById('calcBtn'),
        res = document.getElementById('result'),
        hist = document.getElementById('history'),
        clearBtn = document.getElementById('clearHistory'),
        openTiny = document.getElementById('openTiny'),
        toggleTheme = document.getElementById('toggleTheme');

  let historyArr = JSON.parse(localStorage.getItem('calcHistory')) || [];

  function updatePlaceholders() {
    if (modeEl.value === 'percentOfNumber') {
      xEl.placeholder = 'Процент (X)';
      yEl.placeholder = 'Число (Y)';
    } else if (modeEl.value === 'numberIsPercent') {
      xEl.placeholder = 'Число (X)';
      yEl.placeholder = 'Число (Y)';
    } else if (modeEl.value === 'increaseByPercent') {
      xEl.placeholder = 'Процент (X)';
      yEl.placeholder = 'Число (Y)';
    } else {
      xEl.placeholder = 'Процент (X)';
      yEl.placeholder = 'Результат (Y)';
    }
    res.textContent = '';
    xEl.focus();
  }

  function addHistory(item) {
    historyArr.unshift(item);
    localStorage.setItem('calcHistory', JSON.stringify(historyArr));
    hist.innerHTML = historyArr.map(h => '<div class="history-item">' + h + '</div>').join('');
  }

  function calcPercentOfNumber(x, y) {
    return `${x}% от ${y} = ${(x / 100 * y).toFixed(2)}`;
  }

  function calcNumberIsPercent(x, y) {
    return `${x} = ${(x / y * 100).toFixed(2)}% от ${y}`;
  }

  function calcNumberFromPercent(x, y) {
    const base = y / (x / 100);
    const sum = base + y;
    return `${x}% от ${base.toFixed(2)} = ${y}, сумма: ${sum.toFixed(2)}`;
  }

  function calcIncreaseByPercent(x, y) {
    return `${y} + ${x}% = ${((y * (100 + x)) / 100).toFixed(2)}`;
  }

  function calculate() {
    const x = parseFloat(xEl.value), y = parseFloat(yEl.value);
    if (isNaN(x) || isNaN(y)) {
      res.textContent = 'Введите оба значения';
      return;
    }
    if (modeEl.value === 'numberFromPercent' && x === 0) {
      res.textContent = 'Процент не может быть равен 0';
      return;
    }
    if (modeEl.value === 'numberIsPercent' && y === 0) {
      res.textContent = 'Деление на ноль невозможно';
      return;
    }
    let text = '';
    switch (modeEl.value) {
      case 'percentOfNumber': text = calcPercentOfNumber(x, y); break;
      case 'numberIsPercent': text = calcNumberIsPercent(x, y); break;
      case 'numberFromPercent': text = calcNumberFromPercent(x, y); break;
      case 'increaseByPercent': text = calcIncreaseByPercent(x, y); break;
    }
    res.textContent = text;
    addHistory(text);
  }

  btn.addEventListener('click', calculate);
  [xEl, yEl].forEach(el => 
    el.addEventListener('keypress', ev => ev.key === 'Enter' && calculate())
  );
  clearBtn.addEventListener('click', () => {
    historyArr = [];
    localStorage.setItem('calcHistory', JSON.stringify(historyArr));
    hist.innerHTML = '';
  });
  modeEl.addEventListener('change', updatePlaceholders);
  updatePlaceholders();

  // Валидация ввода в реальном времени
  [xEl, yEl, document.getElementById('minInput'), document.getElementById('secInput')].forEach(el => {
    el.addEventListener('input', () => {
      if (el.value < 0 && (el.id === 'minInput' || el.id === 'secInput')) {
        el.classList.add('invalid');
        res.textContent = 'Отрицательные значения недопустимы для таймера';
      } else {
        el.classList.remove('invalid');
        res.textContent = '';
      }
    });
  });

  // Сброс полей по Esc
  document.addEventListener('keydown', ev => {
    if (ev.key === 'Escape') {
      xEl.value = '';
      yEl.value = '';
      document.getElementById('minInput').value = '';
      document.getElementById('secInput').value = '';
      res.textContent = '';
    }
  });

  // ————— Компактное окно —————
  if (window.name === 'tinyCalc') openTiny.style.display = 'none';

  openTiny.addEventListener('click', () => {
    window.open(window.location.href, 'tinyCalc', 'width=350,height=600,left=100,top=100');
    openTiny.style.display = 'none';
  });

  // ————— Темная тема —————
  toggleTheme.addEventListener('click', () => {
    document.body.classList.toggle('dark');
    document.querySelector('.calculator').classList.toggle('dark');
    document.querySelector('.history').classList.toggle('dark');
  });

  // ————— Таймер —————
  let timerInterval = null, total = 0, initialTotal = 0, isPaused = false;
  const display = document.getElementById('timerDisplay'),
        beep = document.getElementById('beep'),
        timerBtn = document.getElementById('timerBtn'),
        resetTimerBtn = document.getElementById('resetTimerBtn'),
        progressBar = document.getElementById('progressBar'),
        minInput = document.getElementById('minInput'),
        secInput = document.getElementById('secInput');

  function updateTimer() {
    total--;
    if (total < 0) {
      clearInterval(timerInterval);
      display.textContent = '00:00';
      display.classList.add('ending');
      try {
        beep.play();
      } catch (e) {
        console.warn('Не удалось воспроизвести звук таймера:', e);
      }
      timerBtn.querySelector('span').textContent = 'Start Timer';
      timerInterval = null;
      isPaused = false;
      progressBar.style.setProperty('--progress', '0%');
    } else {
      const m = Math.floor(total / 60), s = total % 60;
      display.textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
      progressBar.style.setProperty('--progress', `${(total / initialTotal) * 100}%`);
      if (total < 10) display.classList.add('ending');
    }
  }

  timerBtn.addEventListener('click', () => {
    if (timerInterval && !isPaused) {
      clearInterval(timerInterval);
      timerBtn.querySelector('span').textContent = 'Resume Timer';
      isPaused = true;
      return;
    }
    if (isPaused) {
      const mins = parseInt(minInput.value) || 0;
      const secs = parseInt(secInput.value) || 0;
      total = mins * 60 + secs;
      if (total <= 0) return alert('Установите время.');
      initialTotal = total;
      timerInterval = setInterval(updateTimer, 1000);
      timerBtn.querySelector('span').textContent = 'Pause Timer';
      isPaused = false;
      progressBar.style.setProperty('--progress', `${(total / initialTotal) * 100}%`);
      return;
    }
    const mins = parseInt(minInput.value) || 0;
    const secs = parseInt(secInput.value) || 0;
    total = mins * 60 + secs;
    if (total <= 0) return alert('Установите время.');
    initialTotal = total;
    display.classList.remove('ending');
    timerBtn.querySelector('span').textContent = 'Pause Timer';
    timerInterval = setInterval(updateTimer, 1000);
    progressBar.style.setProperty('--progress', '100%');
  });

  resetTimerBtn.addEventListener('click', () => {
    clearInterval(timerInterval);
    timerInterval = null;
    total = 0;
    initialTotal = 0;
    isPaused = false;
    display.textContent = '00:00';
    display.classList.remove('ending');
    timerBtn.querySelector('span').textContent = 'Start Timer';
    minInput.value = '';
    secInput.value = '';
    progressBar.style.setProperty('--progress', '0%');
  });
</script>

</body>
</html>