<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Калькулятор + Таймер</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }
    body { 
      display: flex; 
      height: 100vh; 
      justify-content: center; 
      align-items: center;
      background: #F2F2F7; 
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', sans-serif; 
      transition: background 0.3s;
    }
    body.dark { background: #1C2526; }
    .calculator { 
      background: rgba(255, 255, 255, 0.9); 
      backdrop-filter: blur(10px);
      border-radius: 12px; 
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      padding: 16px; 
      width: 320px; 
      text-align: center; 
      transition: background 0.3s;
    }
    .calculator.dark { 
      background: rgba(28, 37, 38, 0.9); 
      color: #FFF; 
    }
    input, select { 
      padding: 10px; 
      margin: 6px 0; 
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 10px; 
      font-size: 14px; 
      background: rgba(255, 255, 255, 0.7);
      transition: border-color 0.3s;
    }
    .calculator.dark input, .calculator.dark select { 
      background: rgba(255, 255, 255, 0.1); 
      color: #FFF; 
      border-color: rgba(255, 255, 255, 0.2); 
    }
    input.invalid { border-color: #FF3B30; }
    .input-group {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 6px;
    }
    .input-group #xInput {
      width: calc(33.33% - 4px);
      order: 1;
    }
    .input-group #yInput {
      width: calc(66.66% - 4px);
      order: 2;
    }
    .input-group #sInput {
      width: calc(33.33% - 4px);
      order: 3;
    }
    button { 
      padding: 8px; 
      margin: 10px 4px; 
      border: none; 
      color: #FFF; 
      font-size: 14px;
      border-radius: 10px; 
      cursor: pointer; 
      transition: background 0.3s, transform 0.1s; 
      display: flex; 
      align-items: center; 
      justify-content: center;
      gap: 6px;
    }
    button:active { transform: scale(0.98); }
    #calcBtn { 
      background: #007AFF; 
      width: 100%; 
      font-weight: 600;
    } 
    #calcBtn:hover { background: #005BB5; }
    #openTiny, #toggleTheme, #clearHistory { 
      background: rgba(120, 120, 128, 0.2); 
      width: calc(33.33% - 8px); 
      height: 34px; 
      padding: 6px; 
      color: #007AFF;
    }
    .calculator.dark #openTiny, 
    .calculator.dark #toggleTheme, 
    .calculator.dark #clearHistory { 
      background: rgba(255, 255, 255, 0.1); 
      color: #FFF; 
    }
    #openTiny:hover, #toggleTheme:hover, #clearHistory:hover { 
      background: rgba(120, 120, 128, 0.3); 
    }
    .calculator.dark #openTiny:hover, 
    .calculator.dark #toggleTheme:hover, 
    .calculator.dark #clearHistory:hover { 
      background: rgba(255, 255, 255, 0.2); 
    }
    #timerBtn, #resetTimerBtn { 
      background: #007AFF; 
      width: calc(50% - 8px); 
      font-weight: 500;
    }
    #timerBtn:hover, #resetTimerBtn:hover { 
      background: #005BB5; 
    }
    #resetTimerBtn { background: #FF3B30; } 
    #resetTimerBtn:hover { background: #D32F2F; }
    .button-group { 
      display: flex; 
      justify-content: space-between; 
      flex-wrap: nowrap; 
      align-items: center;
    }
    .timer-button-group { 
      display: flex; 
      justify-content: space-between; 
      flex-wrap: nowrap; 
      align-items: center;
      margin-top: 8px;
    }
    .result { 
      margin-top: 8px; 
      font-size: 15px; 
      min-height: 20px; 
      color: #000; 
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(5px);
      border-radius: 10px;
      padding: 8px;
      font-weight: 500;
    }
    .calculator.dark .result { 
      color: #FFF; 
      background: rgba(255, 255, 255, 0.1); 
    }
    .history { 
      text-align: left; 
      max-height: 100px; 
      overflow-y: auto; 
      margin: 8px 0; 
      padding: 6px;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 10px; 
      font-size: 13px; 
      opacity: 0.9;
      color: #000;
    }
    .calculator.dark .history { 
      background: rgba(255, 255, 255, 0.15); 
      color: #FFF; 
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .history-item { margin-bottom: 4px; }
    .timer-block { 
      display: flex; 
      justify-content: space-between; 
      margin-top: 8px; 
    }
    .timer-block input { width: calc(50% - 4px); }
    .timer-display { 
      margin-top: 8px; 
      font-size: 20px; 
      color: #34C759; 
      font-weight: 600; 
    }
    .timer-display.ending { color: #FF3B30; }
    .progress-bar {
      height: 6px;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 3px;
      margin-top: 8px;
      overflow: hidden;
    }
    .calculator.dark .progress-bar { background: rgba(255, 255, 255, 0.2); }
    .progress-bar::before {
      content: '';
      display: block;
      height: 100%;
      background: #007AFF;
      width: var(--progress, 0);
      transition: width 0.5s ease-out;
    }
    [title]:hover:after {
      content: attr(title);
      position: absolute;
      background: rgba(0, 0, 0, 0.8);
      color: #FFF;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      z-index: 10;
    }
    @media (max-width: 400px) {
      .calculator { width: 90%; padding: 12px; }
      input, select, button { font-size: 13px; }
      .input-group #xInput, .input-group #sInput { width: calc(33.33% - 3px); }
      .input-group #yInput { width: calc(66.66% - 3px); }
      #openTiny, #toggleTheme, #clearHistory { 
        width: calc(33.33% - 6px); 
        height: 32px; 
        padding: 5px; 
      }
      #timerBtn, #resetTimerBtn { width: calc(50% - 6px); }
    }
  </style>
</head>
<body>

<div class="calculator">
  <select id="mode" title="Выберите режим расчета">
    <option value="percentOfNumber">X% от числа Y?</option>
    <option value="numberIsPercent">X — сколько % от Y?</option>
    <option value="numberFromPercent" selected>X% от какого числа Y?</option>
    <option value="increaseByPercent">Увеличить Y на X%</option>
  </select>
  <div class="input-group">
    <input type="number" id="xInput" placeholder="% (X)" title="Введите процентное значение (X)" />
    <input type="text" id="yInput" placeholder="Результат (Y)" title="Введите число или сумму (например, 100+150+230)" />
    <input type="number" id="sInput" placeholder="S" title="Введите число для суммирования с результатом (S)" />
  </div>
  <button id="calcBtn"><i class="fas fa-calculator"></i> <span>Рассчитать</span></button>
  <div class="result" id="result"></div>
  <div class="history" id="history"></div>
  <div class="button-group">
    <button id="clearHistory" title="Очистить историю"><i class="fas fa-trash-can"></i></button>
    <button id="openTiny" title="Открыть компактное окно"><i class="fas fa-window-restore"></i></button>
    <button id="toggleTheme" title="Переключить тему"><i class="fas fa-moon"></i></button>
  </div>
  <div class="timer-block">
    <input type="number" id="minInput" placeholder="Мин" title="Введите минуты" />
    <input type="number" id="secInput" placeholder="Сек" title="Введите секунды" />
  </div>
  <div class="timer-button-group">
    <button id="timerBtn"><i class="fas fa-clock"></i> <span>Start Timer</span></button>
    <button id="resetTimerBtn"><i class="fas fa-rotate-left"></i> <span>Reset Timer</span></button>
  </div>
  <div class="timer-display" id="timerDisplay">00:00</div>
  <div class="progress-bar" id="progressBar"></div>
  <audio id="beep" preload="auto">
    <source src="https://www.soundjay.com/buttons/beep-01a.mp3" type="audio/mpeg">
    <source src="https://www.soundjay.com/buttons/beep-01a.ogg" type="audio/ogg">
  </audio>
</div>

<script>
  // ————— Калькулятор + История —————
  // Инициализация элементов
  const modeEl = document.getElementById('mode'),
        xEl = document.getElementById('xInput'),
        yEl = document.getElementById('yInput'),
        sEl = document.getElementById('sInput'),
        btn = document.getElementById('calcBtn'),
        res = document.getElementById('result'),
        hist = document.getElementById('history'),
        clearBtn = document.getElementById('clearHistory'),
        openTiny = document.getElementById('openTiny'),
        toggleTheme = document.getElementById('toggleTheme');

  // Инициализация истории
  let historyArr = [];
  try {
    historyArr = JSON.parse(localStorage.getItem('calcHistory')) || [];
  } catch (e) {
    console.warn('Ошибка доступа к localStorage:', e);
  }

  // Функция для добавления записи в историю
  function addHistory(item) {
    historyArr.unshift(item);
    try {
      localStorage.setItem('calcHistory', JSON.stringify(historyArr));
    } catch (e) {
      console.warn('Не удалось сохранить историю в localStorage:', e);
    }
    hist.innerHTML = historyArr.map(h => '<div class="history-item">' + h + '</div>').join('');
  }

  // Обновление placeholder'ов и видимости поля S
  function updatePlaceholders() {
    if (modeEl.value === 'percentOfNumber') {
      xEl.placeholder = '% (X)';
      yEl.placeholder = 'Результат (Y)';
      sEl.style.display = 'none';
    } else if (modeEl.value === 'numberIsPercent') {
      xEl.placeholder = 'Число (X)';
      yEl.placeholder = 'Число (Y)';
      sEl.style.display = 'none';
    } else if (modeEl.value === 'increaseByPercent') {
      xEl.placeholder = '% (X)';
      yEl.placeholder = 'Число (Y)';
      sEl.style.display = 'none';
    } else {
      xEl.placeholder = '% (X)';
      yEl.placeholder = 'Результат (Y)';
      sEl.style.display = 'block';
    }
    res.textContent = '';
    xEl.focus();
  }

  // Парсинг строки Y (например, "100+150+230")
  function parseYInput(input) {
    if (!input.includes('+')) {
      return parseFloat(input);
    }
    const numbers = input.split('+').map(num => parseFloat(num.trim()));
    if (numbers.some(isNaN)) {
      return NaN;
    }
    return numbers.reduce((sum, num) => sum + num, 0);
  }

  // Функции расчёта
  function calcPercentOfNumber(x, y) {
    return `${x}% от ${y} = ${(x / 100 * y).toFixed(2)}`;
  }

  function calcNumberIsPercent(x, y) {
    return `${x} = ${(x / y * 100).toFixed(2)}% от ${y}`;
  }

  function calcNumberFromPercent(x, y, s) {
    const base = y / (x / 100);
    let result = `${x}% от ${base.toFixed(2)} = ${y}`;
    if (!isNaN(s) && s !== '') {
      const sum = base + parseFloat(s);
      result += `, сумма с S: ${sum.toFixed(2)}`;
    }
    return result;
  }

  function calcIncreaseByPercent(x, y) {
    return `${y} + ${x}% = ${((y * (100 + x)) / 100).toFixed(2)}`;
  }

  // Основная функция расчёта
  function calculate() {
    const x = parseFloat(xEl.value);
    const yRaw = yEl.value.trim();
    const y = parseYInput(yRaw);
    const s = sEl.value.trim();

    if (isNaN(x) || isNaN(y)) {
      res.textContent = 'Введите корректные значения для X и Y';
      return;
    }
    if (modeEl.value === 'numberFromPercent' && x === 0) {
      res.textContent = 'Процент не может быть равен 0';
      return;
    }
    if (modeEl.value === 'numberIsPercent' && y === 0) {
      res.textContent = 'Деление на ноль невозможно';
      return;
    }
    let text = '';
    switch (modeEl.value) {
      case 'percentOfNumber': text = calcPercentOfNumber(x, y); break;
      case 'numberIsPercent': text = calcNumberIsPercent(x, y); break;
      case 'numberFromPercent': text = calcNumberFromPercent(x, y, s); break;
      case 'increaseByPercent': text = calcIncreaseByPercent(x, y); break;
    }
    res.textContent = text;
    addHistory(text);
  }

  // Обработчики событий
  btn.addEventListener('click', calculate);
  [xEl, yEl, sEl].forEach(el => 
    el.addEventListener('keypress', ev => ev.key === 'Enter' && calculate())
  );
  clearBtn.addEventListener('click', () => {
    historyArr = [];
    try {
      localStorage.setItem('calcHistory', JSON.stringify(historyArr));
    } catch (e) {
      console.warn('Не удалось очистить localStorage:', e);
    }
    hist.innerHTML = '';
  });
  modeEl.addEventListener('change', updatePlaceholders);
  updatePlaceholders();

  // Валидация ввода в реальном времени
  [xEl, yEl, sEl, document.getElementById('minInput'), document.getElementById('secInput')].forEach(el => {
    el.addEventListener('input', () => {
      if (el.value < 0 && (el.id === 'minInput' || el.id === 'secInput' || el.id === 'sInput')) {
        el.classList.add('invalid');
        res.textContent = 'Отрицательные значения недопустимы';
      } else {
        el.classList.remove('invalid');
        res.textContent = '';
      }
    });
  });

  // Сброс полей по Esc
  document.addEventListener('keydown', ev => {
    if (ev.key === 'Escape') {
      xEl.value = '';
      yEl.value = '';
      sEl.value = '';
      document.getElementById('minInput').value = '';
      document.getElementById('secInput').value = '';
      res.textContent = '';
    }
  });

  // ————— Компактное окно —————
  if (window.name === 'tinyCalc') openTiny.style.display = 'none';

  openTiny.addEventListener('click', () => {
    window.open(window.location.href, 'tinyCalc', 'width=350,height=600,left=100,top=100');
    openTiny.style.display = 'none';
  });

  // ————— Темная тема —————
  toggleTheme.addEventListener('click', () => {
    document.body.classList.toggle('dark');
    document.querySelector('.calculator').classList.toggle('dark');
    document.querySelector('.history').classList.toggle('dark');
  });

  // ————— Таймер —————
  let timerInterval = null, total = 0, initialTotal = 0, isPaused = false;
  const display = document.getElementById('timerDisplay'),
        beep = document.getElementById('beep'),
        timerBtn = document.getElementById('timerBtn'),
        resetTimerBtn = document.getElementById('resetTimerBtn'),
        progressBar = document.getElementById('progressBar'),
        minInput = document.getElementById('minInput'),
        secInput = document.getElementById('secInput');

  function updateTimer() {
    total--;
    if (total < 0) {
      clearInterval(timerInterval);
      display.textContent = '00:00';
      display.classList.add('ending');
      try {
        beep.play();
      } catch (e) {
        console.warn('Не удалось воспроизвести звук таймера:', e);
      }
      timerBtn.querySelector('span').textContent = 'Start Timer';
      timerInterval = null;
      isPaused = false;
      progressBar.style.setProperty('--progress', '0%');
    } else {
      const m = Math.floor(total / 60), s = total % 60;
      display.textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
      progressBar.style.setProperty('--progress', `${(total / initialTotal) * 100}%`);
      if (total < 10) display.classList.add('ending');
    }
  }

  timerBtn.addEventListener('click', () => {
    if (timerInterval && !isPaused) {
      clearInterval(timerInterval);
      timerBtn.querySelector('span').textContent = 'Resume Timer';
      isPaused = true;
      return;
    }
    if (isPaused) {
      if (total <= 0) {
        alert('Установите время.');
        return;
      }
      timerInterval = setInterval(updateTimer, 1000);
      timerBtn.querySelector('span').textContent = 'Pause Timer';
      isPaused = false;
      progressBar.style.setProperty('--progress', `${(total / initialTotal) * 100}%`);
      return;
    }
    const mins = parseInt(minInput.value) || 0;
    const secs = parseInt(secInput.value) || 0;
    total = mins * 60 + secs;
    if (total <= 0) return alert('Установите время.');
    initialTotal = total;
    display.classList.remove('ending');
    timerBtn.querySelector('span').textContent = 'Pause Timer';
    timerInterval = setInterval(updateTimer, 1000);
    progressBar.style.setProperty('--progress', '100%');
  });

  resetTimerBtn.addEventListener('click', () => {
    clearInterval(timerInterval);
    timerInterval = null;
    total = 0;
    initialTotal = 0;
    isPaused = false;
    display.textContent = '00:00';
    display.classList.remove('ending');
    timerBtn.querySelector('span').textContent = 'Start Timer';
    minInput.value = '';
    secInput.value = '';
    progressBar.style.setProperty('--progress', '0%');
  });
</script>

</body>
</html>