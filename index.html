<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <!-- Мета-теги для iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Калькулятор + Таймер">
  <!-- Ссылка на манифест -->
  <link rel="manifest" href="/manifest.json">
  <!-- Иконки для домашнего экрана -->
  <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png">
  <title>Калькулятор + Таймер</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    html, body { 
      height: 100%; 
      overflow: hidden; 
      touch-action: pan-y;
      margin: 0;
      padding: 0;
    }
    body { 
      display: flex; 
      justify-content: center; 
      align-items: center;
      background: #F2F2F7; 
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', sans-serif; 
      transition: background 0.3s;
    }
    body.dark { background: #1C2526; }
    .calculator { 
      background: rgba(255, 255, 255, 0.9); 
      backdrop-filter: blur(10px);
      border-radius: 12px; 
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      padding: 16px; 
      width: 320px; 
      max-height: calc(100vh - 100px);
      text-align: center; 
      transition: background 0.3s;
      overflow-y: auto;
    }
    .calculator.dark { 
      background: rgba(28, 37, 38, 0.9); 
      color: #FFF; 
    }
    input, select { 
      padding: 10px; 
      margin: 6px 0; 
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 10px; 
      font-size: 14px; 
      background: rgba(255, 255, 255, 0.7);
      transition: border-color 0.3s;
    }
    .calculator.dark input, .calculator.dark select { 
      background: rgba(255, 255, 255, 0.1); 
      color: #FFF; 
      border-color: rgba(255, 255, 255, 0.2); 
    }
    input.invalid { border-color: #FF3B30; }
    .input-group {
      display: flex;
      flex-wrap: nowrap;
      justify-content: space-between;
      gap: 6px;
    }
    .input-group #xInput {
      width: 30%;
    }
    .input-group #yInput {
      width: 70%;
    }
    .calc-group {
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }
    .calc-group #sInput {
      width: 30%;
    }
    .calc-group #calcBtn {
      width: 70%;
      background: #007AFF;
      font-weight: 600;
    }
    .calc-group #calcBtn:hover {
      background: #005BB5;
    }
    button { 
      padding: 8px; 
      margin: 6px 0; 
      border: none; 
      color: #FFF; 
      font-size: 14px;
      border-radius: 10px; 
      cursor: pointer; 
      transition: background 0.3s, transform 0.1s; 
      display: flex; 
      align-items: center; 
      justify-content: center;
      gap: 6px;
    }
    button:active { transform: scale(0.98); }
    #openTiny, #toggleTheme, #clearHistory, #toggleRound, #toggleHistory { 
      background: rgba(120, 120, 128, 0.2); 
      width: calc(25% - 8px); 
      height: 34px; 
      padding: 6px; 
      color: #007AFF;
    }
    .calculator.dark #openTiny, 
    .calculator.dark #toggleTheme, 
    .calculator.dark #clearHistory,
    .calculator.dark #toggleRound,
    .calculator.dark #toggleHistory { 
      background: rgba(255, 255, 255, 0.1); 
      color: #FFF; 
    }
    #openTiny:hover, #toggleTheme:hover, #clearHistory:hover, #toggleRound:hover, #toggleHistory:hover { 
      background: rgba(120, 120, 128, 0.3); 
    }
    .calculator.dark #openTiny:hover, 
    .calculator.dark #toggleTheme:hover, 
    .calculator.dark #clearHistory:hover,
    .calculator.dark #toggleRound:hover,
    .calculator.dark #toggleHistory:hover { 
      background: rgba(255, 255, 255, 0.2); 
    }
    .mode-group {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }
    .mode-group select {
      flex-grow: 1;
    }
    .mode-group #openTiny {
      width: 34px;
      height: 34px;
    }
    #timerBtn, #resetTimerBtn { 
      background: #007AFF; 
      width: calc(50% - 8px); 
      font-weight: 500;
    }
    #timerBtn:hover, #resetTimerBtn:hover { 
      background: #005BB5; 
    }
    #resetTimerBtn { background: #FF3B30; } 
    #resetTimerBtn:hover { background: #D32F2F; }
    .button-group { 
      display: flex; 
      justify-content: space-between; 
      flex-wrap: nowrap; 
      align-items: center;
      margin-top: 8px;
      gap: 6px;
    }
    .timer-button-group { 
      display: flex; 
      justify-content: space-between; 
      flex-wrap: nowrap; 
      align-items: center;
      margin-top: 8px;
    }
    .quick-timer-buttons {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-top: 8px;
    }
    .quick-timer-buttons button {
      background: rgba(120, 120, 128, 0.2);
      color: #007AFF;
      width: calc(33.33% - 4px);
      font-size: 13px;
      padding: 6px;
    }
    .calculator.dark .quick-timer-buttons button {
      background: rgba(255, 255, 255, 0.1);
      color: #FFF;
    }
    .quick-timer-buttons button:hover {
      background: rgba(120, 120, 128, 0.3);
    }
    .calculator.dark .quick-timer-buttons button:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    .result { 
      margin-top: 8px; 
      font-size: 15px; 
      min-height: 20px; 
      color: #000; 
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(5px);
      border-radius: 10px;
      padding: 8px;
      font-weight: 500;
      position: relative;
    }
    .calculator.dark .result { 
      color: #FFF; 
      background: rgba(255, 255, 255, 0.1); 
    }
    .sum-result {
      display: block;
      margin-top: 8px;
      padding: 6px 10px;
      background: rgba(0, 122, 255, 0.2);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .calculator.dark .sum-result {
      background: rgba(255, 255, 255, 0.3);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .copy-btn {
      background: #007AFF;
      color: #FFF;
      font-size: 12px;
      padding: 4px 8px;
      margin-left: 8px;
      border-radius: 6px;
      display: inline-flex;
      gap: 4px;
      min-width: 32px;
    }
    .calculator.dark .copy-btn {
      background: #005BB5;
    }
    .copy-btn:hover {
      background: #005BB5;
    }
    .calculator.dark .copy-btn:hover {
      background: #004085;
    }
    .history { 
      text-align: left; 
      max-height: 100px; 
      overflow-y: auto; 
      margin: 8px 0; 
      padding: 6px;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 10px; 
      font-size: 13px; 
      opacity: 0.9;
      color: #000;
      transition: max-height 0.3s ease, opacity 0.3s ease;
    }
    .calculator.dark .history { 
      background: rgba(255, 255, 255, 0.15); 
      color: #FFF; 
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .history.hidden {
      max-height: 0;
      padding: 0;
      border: none;
      opacity: 0;
      overflow: hidden;
    }
    .history-item { margin-bottom: 4px; }
    .timer-block { 
      display: flex; 
      justify-content: space-between; 
      margin-top: 8px; 
      gap: 10px;
    }
    .timer-block input { width: 48%; }
    .timer-display { 
      margin-top: 8px; 
      font-size: 20px; 
      color: #34C759; 
      font-weight: 600; 
    }
    .timer-display.ending { color: #FF3B30; }
    .progress-bar {
      height: 6px;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 3px;
      margin-top: 8px;
      overflow: hidden;
    }
    .calculator.dark .progress-bar { background: rgba(255, 255, 255, 0.2); }
    .progress-bar::before {
      content: '';
      display: block;
      height: 100%;
      background: #007AFF;
      width: var(--progress, 0);
      transition: width 0.5s ease-out;
    }
    [title]:hover:after {
      content: attr(title);
      position: absolute;
      background: rgba(0, 0, 0, 0.8);
      color: #FFF;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      z-index: 10;
    }
    @media (max-width: 400px) {
      .calculator { 
        width: 90%; 
        padding: 12px; 
        max-height: calc(100vh - 150px); 
      }
      input, select, button { font-size: 13px; }
      .input-group #xInput { width: 30%; }
      .input-group #yInput { width: 70%; }
      .calc-group #sInput { width: 30%; }
      .calc-group #calcBtn { width: 70%; }
      #openTiny, #toggleTheme, #clearHistory, #toggleRound, #toggleHistory { 
        width: calc(25% - 6px); 
        height: 32px; 
        padding: 5px; 
      }
      .mode-group #openTiny {
        width: 32px;
        height: 32px;
      }
      #timerBtn, #resetTimerBtn { width: calc(50% - 6px); }
      .quick-timer-buttons button {
        width: calc(33.33% - 4px);
        font-size: 12px;
      }
    }
    /* Новый стиль для кнопки toggleRound */
    #toggleRound {
      background: rgba(142, 142, 147, 0.2); /* Серый цвет #8E8E93 */
    }
    #toggleRound i {
      color: #8E8E93; /* Серый цвет для иконки */
      transition: color 0.3s;
    }
    #toggleRound.off i {
      color: #8E8E93; /* Серый цвет остается постоянным */
    }
    .calculator.dark #toggleRound {
      background: rgba(255, 255, 255, 0.1);
    }
    .calculator.dark #toggleRound i {
      color: #8E8E93; /* Серый цвет в темной теме */
    }
  </style>
</head>
<body>

<div class="calculator">
  <div class="mode-group">
    <select id="mode" title="Выберите режим расчета">
      <option value="percentOfNumber">X% от числа Y?</option>
      <option value="numberIsPercent">X — сколько % от Y?</option>
      <option value="numberFromPercent" selected>X% от какого числа Y?</option>
      <option value="increaseByPercent">Увеличить Y на X%</option>
    </select>
    <button id="openTiny" title="Открыть компактное окно"><i class="fas fa-window-restore"></i></button>
  </div>
  <div class="input-group">
    <input type="number" id="xInput" inputmode="numeric" placeholder="% (X)" title="Введите процентное значение (X)" />
    <input type="text" id="yInput" pattern="[0-9+\s]*" placeholder="Результат (Y)" title="Введите число или сумму (например, 100+150+230)" />
  </div>
  <div class="calc-group">
    <input type="number" id="sInput" inputmode="numeric" placeholder="(S)" title="Введите число для суммирования с результатом (S)" />
    <button id="calcBtn"><i class="fas fa-calculator"></i> <span>Рассчитать</span></button>
  </div>
  <div class="result" id="result"></div>
  <div class="history" id="history"></div>
  <div class="button-group">
    <button id="clearHistory" title="Очистить историю"><i class="fas fa-trash-can"></i></button>
    <button id="toggleRound" title="Переключить округление"><i class="fas fa-sync-alt"></i></button>
    <button id="toggleHistory" title="Свернуть историю"><i class="fas fa-eye-slash"></i></button>
    <button id="toggleTheme" title="Переключить тему"><i class="fas fa-moon"></i></button>
  </div>
  <div class="timer-block">
    <input type="number" id="minInput" inputmode="numeric" placeholder="Мин" title="Введите минуты" />
    <input type="number" id="secInput" inputmode="numeric" placeholder="Сек" title="Введите секунды" />
  </div>
  <div class="quick-timer-buttons">
    <button class="quick-timer" data-minutes="1">1 мин</button>
    <button class="quick-timer" data-minutes="4">4 мин</button>
    <button class="quick-timer" data-minutes="10">10 мин</button>
  </div>
  <div class="timer-button-group">
    <button id="timerBtn"><i class="fas fa-clock"></i> <span>Start Timer</span></button>
    <button id="resetTimerBtn"><i class="fas fa-rotate-left"></i> <span>Reset Timer</span></button>
  </div>
  <div class="timer-display" id="timerDisplay">00:00</div>
  <div class="progress-bar" id="progressBar"></div>
  <audio id="beep" preload="auto">
    <source src="https://www.soundjay.com/buttons/beep-01a.mp3" type="audio/mpeg">
    <source src="https://www.soundjay.com/buttons/beep-01a.ogg" type="audio/ogg">
  </audio>
</div>

<script>
  // ————— Регистрация Service Worker —————
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then(reg => console.log('Service Worker зарегистрирован:', reg))
        .catch(err => console.warn('Ошибка регистрации Service Worker:', err));
    });
  }

  // ————— Уведомления —————
  async function requestNotificationPermission() {
    if (!('Notification' in window)) return false;
    if (Notification.permission === 'granted') return true;
    if (Notification.permission !== 'denied') {
      const res = await Notification.requestPermission();
      return res === 'granted';
    }
    return false;
  }

  function sendNotification(title, body) {
    if (Notification.permission !== 'granted' || document.hasFocus()) return;
    const notification = new Notification(title, { body, silent: true });
    notification.onclick = () => {
      window.focus();
      notification.close();
    };
  }

  // ————— Web Audio API —————
  let audioCtx;
  try {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const gainNode = audioCtx.createGain();
    gainNode.gain.value = 2.0;
    gainNode.connect(audioCtx.destination);

    function beepOsc() {
      const osc = audioCtx.createOscillator();
      osc.type = 'sine';
      osc.frequency.value = 440;
      osc.connect(gainNode);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.5);
    }
  } catch (e) {
    console.warn('Web Audio API недоступен:', e);
  }

  // ————— Вспомогательная функция для копирования —————
  function copyToClipboard(text) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(() => {
        alert('Скопировано!');
      }).catch(err => {
        console.warn('Clipboard API недоступен:', err);
        fallbackCopyToClipboard(text);
      });
    } else {
      fallbackCopyToClipboard(text);
    }
  }

  function fallbackCopyToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.opacity = '0';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    try {
      document.execCommand('copy');
      alert('Скопировано!');
    } catch (err) {
      console.warn('Ошибка копирования через execCommand:', err);
      alert('Не удалось скопировать. Пожалуйста, скопируйте вручную.');
    }
    document.body.removeChild(textArea);
  }

  // ————— Калькулятор + История —————
  const modeEl = document.getElementById('mode'),
        xEl = document.getElementById('xInput'),
        yEl = document.getElementById('yInput'),
        sEl = document.getElementById('sInput'),
        btn = document.getElementById('calcBtn'),
        res = document.getElementById('result'),
        hist = document.getElementById('history'),
        clearBtn = document.getElementById('clearHistory'),
        toggleRoundBtn = document.getElementById('toggleRound'),
        toggleHistoryBtn = document.getElementById('toggleHistory'),
        openTiny = document.getElementById('openTiny'),
        toggleTheme = document.getElementById('toggleTheme');

  let historyArr = [];
  let isRounding = true; // По умолчанию включаем округление
  try {
    historyArr = JSON.parse(localStorage.getItem('calcHistory')) || [];
    isRounding = localStorage.getItem('isRounding') !== 'false'; // Загружаем состояние округления
    toggleRoundBtn.textContent = ' '; // Устанавливаем только пробел для выравнивания
    toggleRoundBtn.classList.toggle('off', !isRounding); // Добавляем/удаляем класс для цвета
  } catch (e) {
    console.warn('Ошибка доступа к localStorage:', e);
  }

  function addHistory(item) {
    const cleanItem = item.replace(/<[^>]+>/g, '');
    historyArr.unshift(cleanItem);
    try {
      localStorage.setItem('calcHistory', JSON.stringify(historyArr));
    } catch (e) {
      console.warn('Не удалось сохранить историю в localStorage:', e);
    }
    hist.innerHTML = historyArr.map(h => '<div class="history-item">' + h + '</div>').join('');
  }

  function updatePlaceholders() {
    if (modeEl.value === 'percentOfNumber') {
      xEl.placeholder = '% (X)';
      yEl.placeholder = 'Результат (Y)';
      sEl.style.display = 'none';
    } else if (modeEl.value === 'numberIsPercent') {
      xEl.placeholder = 'Число (X)';
      yEl.placeholder = 'Число (Y)';
      sEl.style.display = 'none';
    } else if (modeEl.value === 'increaseByPercent') {
      xEl.placeholder = '% (X)';
      yEl.placeholder = 'Число (Y)';
      sEl.style.display = 'none';
    } else {
      xEl.placeholder = '% (X)';
      yEl.placeholder = 'Результат (Y)';
      sEl.style.display = 'block';
    }
    res.textContent = '';
    xEl.focus();
  }

  function parseYInput(input) {
    if (!input.includes('+')) {
      return parseFloat(input);
    }
    const numbers = input.split('+').map(num => parseFloat(num.trim()));
    if (numbers.some(isNaN)) {
      return NaN;
    }
    return numbers.reduce((sum, num) => sum + num, 0);
  }

  function calcPercentOfNumber(x, y) {
    return `${x}% от ${y} = ${(x / 100 * y).toFixed(2)}`;
  }

  function calcNumberIsPercent(x, y) {
    return `${x} = ${(x / y * 100).toFixed(2)}% от ${y}`;
  }

  function calcNumberFromPercent(x, y, s) {
    const base = y / (x / 100);
    let result = `${x}% от ${isRounding ? Math.ceil(base) : base.toFixed(2)} = ${y}`;
    if (!isNaN(s) && s !== '') {
      const sum = base + parseFloat(s);
      result += `<div class="sum-result">Сумма с S: ${isRounding ? Math.ceil(sum) : sum.toFixed(2)}<button class="copy-btn" aria-label="Скопировать сумму" onclick="copyToClipboard('${isRounding ? Math.ceil(sum) : sum.toFixed(2)}')"><i class="fas fa-copy"></i></button></div>`;
    }
    return result;
  }

  function calcIncreaseByPercent(x, y) {
    return `${y} + ${x}% = ${((y * (100 + x)) / 100).toFixed(2)}`;
  }

  function calculate() {
    const x = parseFloat(xEl.value);
    const yRaw = yEl.value.trim();
    const y = parseYInput(yRaw);
    const s = sEl.value.trim();

    if (isNaN(x) || isNaN(y)) {
      res.textContent = 'Введите корректные значения для X и Y';
      return;
    }
    if (modeEl.value === 'numberFromPercent' && x === 0) {
      res.textContent = 'Процент не может быть равен 0';
      return;
    }
    if (modeEl.value === 'numberIsPercent' && y === 0) {
      res.textContent = 'Деление на ноль невозможно';
      return;
    }
    let text = '';
    switch (modeEl.value) {
      case 'percentOfNumber': text = calcPercentOfNumber(x, y); break;
      case 'numberIsPercent': text = calcNumberIsPercent(x, y); break;
      case 'numberFromPercent': text = calcNumberFromPercent(x, y, s); break;
      case 'increaseByPercent': text = calcIncreaseByPercent(x, y); break;
    }
    res.innerHTML = text;
    addHistory(text);
  }

  btn.addEventListener('click', calculate);
  [xEl, yEl, sEl].forEach(el => 
    el.addEventListener('keypress', ev => ev.key === 'Enter' && calculate())
  );
  clearBtn.addEventListener('click', () => {
    historyArr = [];
    try {
      localStorage.setItem('calcHistory', JSON.stringify(historyArr));
    } catch (e) {
      console.warn('Не удалось очистить localStorage:', e);
    }
    hist.innerHTML = '';
  });
  toggleRoundBtn.addEventListener('click', () => {
    isRounding = !isRounding;
    toggleRoundBtn.textContent = ' '; // Устанавливаем только пробел для выравнивания
    toggleRoundBtn.classList.toggle('off', !isRounding); // Переключаем класс для цвета
    try {
      localStorage.setItem('isRounding', isRounding);
    } catch (e) {
      console.warn('Не удалось сохранить состояние округления в localStorage:', e);
    }
    calculate(); // Пересчитываем результат с новым состоянием округления
  });
  modeEl.addEventListener('change', updatePlaceholders);
  updatePlaceholders();

  // Валидация yInput
  yEl.addEventListener('input', () => {
    const validInput = /^[0-9+\s]*$/.test(yEl.value);
    if (!validInput) {
      yEl.classList.add('invalid');
      res.textContent = 'Допустимы только цифры, + и пробелы';
    } else {
      yEl.classList.remove('invalid');
      res.textContent = '';
    }
  });

  [xEl, yEl, sEl, document.getElementById('minInput'), document.getElementById('secInput')].forEach(el => {
    el.addEventListener('input', () => {
      if (el.value < 0 && (el.id === 'minInput' || el.id === 'secInput' || el.id === 'sInput')) {
        el.classList.add('invalid');
        res.textContent = 'Отрицательные значения недопустимы';
      } else if (el.id !== 'yInput') {
        el.classList.remove('invalid');
        res.textContent = '';
      }
    });
  });

  document.addEventListener('keydown', ev => {
    if (ev.key === 'Escape') {
      xEl.value = '';
      yEl.value = '';
      sEl.value = '';
      document.getElementById('minInput').value = '';
      document.getElementById('secInput').value = '';
      res.textContent = '';
    }
  });

  // ————— Сворачивание истории —————
  let isHistoryHidden = localStorage.getItem('historyHidden') === 'true';
  if (isHistoryHidden) {
    hist.classList.add('hidden');
    toggleHistoryBtn.querySelector('i').classList.replace('fa-eye-slash', 'fa-history');
    toggleHistoryBtn.title = 'Развернуть историю';
  }

  toggleHistoryBtn.addEventListener('click', () => {
    isHistoryHidden = !isHistoryHidden;
    hist.classList.toggle('hidden');
    if (isHistoryHidden) {
      toggleHistoryBtn.querySelector('i').classList.replace('fa-eye-slash', 'fa-history');
      toggleHistoryBtn.title = 'Развернуть историю';
    } else {
      toggleHistoryBtn.querySelector('i').classList.replace('fa-history', 'fa-eye-slash');
      toggleHistoryBtn.title = 'Свернуть историю';
    }
    try {
      localStorage.setItem('historyHidden', isHistoryHidden);
    } catch (e) {
      console.warn('Ошибка сохранения состояния истории в localStorage:', e);
    }
  });

  // ————— Компактное окно —————
  if (window.name === 'tinyCalc') openTiny.style.display = 'none';

  openTiny.addEventListener('click', () => {
    window.open(window.location.href, 'tinyCalc', 'width=350,height=600,left=100,top=100');
    openTiny.style.display = 'none';
  });

  // ————— Темная тема —————
  toggleTheme.addEventListener('click', () => {
    document.body.classList.toggle('dark');
    document.querySelector('.calculator').classList.toggle('dark');
    document.querySelector('.history').classList.toggle('dark');
  });

  // ————— Таймер с requestAnimationFrame —————
  let timerInterval = null, total = 0, initialTotal = 0, isPaused = false, lastFrameTime = 0, timerEndTime = 0;
  const display = document.getElementById('timerDisplay'),
        timerBtn = document.getElementById('timerBtn'),
        resetTimerBtn = document.getElementById('resetTimerBtn'),
        progressBar = document.getElementById('progressBar'),
        minInput = document.getElementById('minInput'),
        secInput = document.getElementById('secInput'),
        beepAudio = document.getElementById('beep');

  function updateTimer(time) {
    if (isPaused || total <= 0) return;
    
    if (!lastFrameTime) lastFrameTime = time;
    const delta = (time - lastFrameTime) / 1000;
    if (delta >= 1) {
      total -= Math.floor(delta);
      lastFrameTime = time;
      if (total <= 0 || Date.now() >= timerEndTime) {
        total = 0;
        display.textContent = '00:00';
        display.classList.add('ending');
        if (audioCtx) {
          try {
            beepOsc();
          } catch (e) {
            console.warn('Ошибка воспроизведения Web Audio:', e);
            try {
              beepAudio.play();
            } catch (e) {
              console.warn('Ошибка воспроизведения запасного звука:', e);
            }
          }
        } else {
          try {
            beepAudio.play();
          } catch (e) {
            console.warn('Ошибка воспроизведения запасного звука:', e);
          }
        }
        sendNotification('Таймер завершён', 'Время вышло!');
        timerBtn.querySelector('span').textContent = 'Start Timer';
        timerInterval = null;
        isPaused = false;
        progressBar.style.setProperty('--progress', '0%');
        timerEndTime = 0;
        return;
      }
      const m = Math.floor(total / 60), s = total % 60;
      display.textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
      progressBar.style.setProperty('--progress', `${(total / initialTotal) * 100}%`);
      if (total < 10) display.classList.add('ending');
    }
    if (timerInterval) requestAnimationFrame(updateTimer);
  }

  // Проверка таймера при возвращении в приложение
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible' && timerEndTime > 0 && Date.now() >= timerEndTime) {
      total = 0;
      display.textContent = '00:00';
      display.classList.add('ending');
      sendNotification('Таймер завершён', 'Время вышло!');
      if (audioCtx) {
        try {
          beepOsc();
        } catch (e) {
          console.warn('Ошибка воспроизведения Web Audio:', e);
          try {
            beepAudio.play();
          } catch (e) {
            console.warn('Ошибка воспроизведения запасного звука:', e);
          }
        }
      } else {
        try {
          beepAudio.play();
        } catch (e) {
          console.warn('Ошибка воспроизведения запасного звука:', e);
        }
      }
      timerBtn.querySelector('span').textContent = 'Start Timer';
      if (timerInterval) {
        cancelAnimationFrame(timerInterval);
        timerInterval = null;
      }
      isPaused = false;
      progressBar.style.setProperty('--progress', '0%');
      timerEndTime = 0;
    }
  });

  timerBtn.addEventListener('click', async () => {
    if (!timerInterval && total <= 0) {
      await requestNotificationPermission();
    }
    if (timerInterval && !isPaused) {
      timerInterval = null;
      timerBtn.querySelector('span').textContent = 'Resume Timer';
      isPaused = true;
      return;
    }
    if (isPaused) {
      if (total <= 0) {
        alert('Установите время.');
        return;
      }
      lastFrameTime = 0;
      timerInterval = requestAnimationFrame(updateTimer);
      timerBtn.querySelector('span').textContent = 'Pause Timer';
      isPaused = false;
      return;
    }
    const mins = parseInt(minInput.value) || 0;
    const secs = parseInt(secInput.value) || 0;
    total = mins * 60 + secs;
    if (total <= 0) return alert('Установите время.');
    initialTotal = total;
    timerEndTime = Date.now() + total * 1000;
    display.classList.remove('ending');
    timerBtn.querySelector('span').textContent = 'Pause Timer';
    lastFrameTime = 0;
    timerInterval = requestAnimationFrame(updateTimer);
    progressBar.style.setProperty('--progress', '100%');
  });

  resetTimerBtn.addEventListener('click', () => {
    if (timerInterval) {
      cancelAnimationFrame(timerInterval);
      timerInterval = null;
    }
    total = 0;
    initialTotal = 0;
    isPaused = false;
    timerEndTime = 0;
    display.textContent = '00:00';
    display.classList.remove('ending');
    timerBtn.querySelector('span').textContent = 'Start Timer';
    minInput.value = '';
    secInput.value = '';
    progressBar.style.setProperty('--progress', '0%');
  });

  // Быстрые значения таймера
  document.querySelectorAll('.quick-timer').forEach(button => {
    button.addEventListener('click', async () => {
      const minutes = parseInt(button.getAttribute('data-minutes'));
      minInput.value = minutes;
      secInput.value = '0';
      minInput.classList.remove('invalid');
      secInput.classList.remove('invalid');
      res.textContent = '';
      if (!timerInterval) {
        await requestNotificationPermission();
        total = minutes * 60;
        initialTotal = total;
        timerEndTime = Date.now() + total * 1000;
        display.classList.remove('ending');
        timerBtn.querySelector('span').textContent = 'Pause Timer';
        lastFrameTime = 0;
        timerInterval = requestAnimationFrame(updateTimer);
        progressBar.style.setProperty('--progress', '100%');
      }
    });
  });
</script>

</body>
</html>