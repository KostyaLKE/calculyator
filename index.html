<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Калькулятор + Таймер</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      display: flex; 
      height: 100vh; 
      justify-content: center; 
      align-items: center;
      background: #eef2f7; 
      font-family: 'Segoe UI', Tahoma, sans-serif; 
      transition: background 0.3s;
    }
    body.dark { background: #333; }
    .calculator { 
      background: #fff; 
      border-radius: 12px; 
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      padding: 20px; 
      width: 320px; 
      text-align: center; 
      transition: background 0.3s;
    }
    .calculator.dark { background: #444; color: #fff; }
    h2 { color: #333; font-weight: 500; margin-bottom: 12px; }
    .calculator.dark h2 { color: #fff; }
    input, select { 
      padding: 10px; 
      margin: 5px 0; 
      border: 1px solid #ccd0d5;
      border-radius: 6px; 
      font-size: 14px; 
      width: 100%; 
      transition: border-color 0.3s;
    }
    .calculator.dark input, .calculator.dark select { 
      background: #555; 
      color: #fff; 
      border-color: #666; 
    }
    input.invalid { border-color: red; }
    button { 
      padding: 10px; 
      margin: 8px 0; 
      border: none; 
      color: #fff; 
      font-size: 14px;
      border-radius: 6px; 
      cursor: pointer; 
      transition: background 0.3s, transform 0.1s; 
      width: 100%; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      gap: 8px;
    }
    button:active { transform: scale(0.95); }
    #calcBtn { background: #4a90e2; } #calcBtn:hover { background: #357ab8; }
    #openTiny { background: #34a853; } #openTiny:hover { background: #2c8e47; }
    #timerBtn { background: #f39c12; } #timerBtn:hover { background: #d77b0c; }
    #resetTimerBtn { background: #e74c3c; } #resetTimerBtn:hover { background: #c0392b; }
    #toggleTheme { background: #8e44ad; } #toggleTheme:hover { background: #732d91; }
    #clearHistory { background: #7f8c8d; } #clearHistory:hover { background: #6c7a89; }
    .result { 
      margin-top: 10px; 
      font-size: 16px; 
      min-height: 20px; 
      color: #222; 
    }
    .calculator.dark .result { color: #fff; }
    .history { 
      text-align: left; 
      max-height: 100px; 
      overflow-y: auto; 
      margin: 10px 0; 
      padding: 5px;
      border: 1px solid #ddd; 
      border-radius: 6px; 
      background: #fafafa; 
      font-size: 14px; 
    }
    .calculator.dark .history { 
      background: #555; 
      border-color: #666; 
    }
    .history-item { margin-bottom: 4px; }
    .timer-block { 
      display: flex; 
      justify-content: space-between; 
      margin-top: 10px; 
    }
    .timer-block input { width: 48%; }
    .timer-display { 
      margin-top: 10px; 
      font-size: 22px; 
      color: green; 
      font-weight: bold; 
    }
    .timer-display.ending { color: red; }
    .progress-bar {
      height: 10px;
      background: #ddd;
      border-radius: 5px;
      margin-top: 10px;
      overflow: hidden;
    }
    .calculator.dark .progress-bar { background: #666; }
    .progress-bar::before {
      content: '';
      display: block;
      height: 100%;
      background: #4a90e2;
      width: var(--progress, 0);
      transition: width 1s linear;
    }
    [title]:hover:after {
      content: attr(title);
      position: absolute;
      background: #333;
      color: #fff;
      padding: 5px;
      border-radius: 4px;
      font-size: 12px;
      z-index: 10;
    }
    @media (max-width: 400px) {
      .calculator { width: 90%; padding: 15px; }
      input, select, button { font-size: 12px; }
    }
  </style>
</head>
<body>

<div class="calculator">
  <select id="mode" title="Выберите режим расчета">
    <option value="percentOfNumber">X% от числа Y?</option>
    <option value="numberIsPercent">X — сколько % от Y?</option>
    <option value="numberFromPercent" selected>X% от какого числа Y?</option>
    <option value="increaseByPercent">Увеличить Y на X%</option>
  </select>
  <input type="number" id="xInput" placeholder="Процент (X)" title="Введите процентное значение (X)" />
  <input type="number" id="yInput" placeholder="Результат (Y)" title="Введите число или результат (Y)" />
  <button id="calcBtn"><i class="fas fa-calculator"></i> Рассчитать</button>
  <div class="result" id="result"></div>
  <div class="history" id="history"></div>
  <button id="clearHistory"><i class="fas fa-trash"></i> Очистить историю</button>
  <button id="openTiny"><i class="fas fa-window-restore"></i> Открыть компактное окно</button>
  <button id="toggleTheme"><i class="fas fa-moon"></i> Переключить тему</button>
  
  <div class="timer-block">
    <input type="number" id="minInput" placeholder="Мин" title="Введите минуты" />
    <input type="number" id="secInput" placeholder="Сек" title="Введите секунды" />
  </div>
  <button id="timerBtn"><i class="fas fa-clock"></i> <span>Start Timer</span></button>
  <button id="resetTimerBtn"><i class="fas fa-undo"></i> Reset Timer</button>
  <div class="timer-display" id="timerDisplay">00:00</div>
  <div class="progress-bar" id="progressBar"></div>
  <audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
  <audio id="calcBeep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
</div>

<script>
  // ————— Калькулятор + История —————
  const modeEl = document.getElementById('mode'),
        xEl = document.getElementById('xInput'),
        yEl = document.getElementById('yInput'),
        btn = document.getElementById('calcBtn'),
        res = document.getElementById('result'),
        hist = document.getElementById('history'),
        clearBtn = document.getElementById('clearHistory'),
        openTiny = document.getElementById('openTiny'),
        calcBeep = document.getElementById('calcBeep');

  let historyArr = JSON.parse(localStorage.getItem('calcHistory')) || [];

  function updatePlaceholders() {
    if (modeEl.value === 'percentOfNumber') {
      xEl.placeholder = 'Процент (X)';
      yEl.placeholder = 'Число (Y)';
    } else if (modeEl.value === 'numberIsPercent') {
      xEl.placeholder = 'Число (X)';
      yEl.placeholder = 'Число (Y)';
    } else if (modeEl.value === 'increaseByPercent') {
      xEl.placeholder = 'Процент (X)';
      yEl.placeholder = 'Число (Y)';
    } else {
      xEl.placeholder = 'Процент (X)';
      yEl.placeholder = 'Результат (Y)';
    }
    res.textContent = '';
    xEl.focus();
  }

  function addHistory(item) {
    historyArr.unshift(item);
    localStorage.setItem('calcHistory', JSON.stringify(historyArr));
    hist.innerHTML = historyArr.map(h => '<div class="history-item">' + h + '</div>').join('');
  }

  function calcPercentOfNumber(x, y) {
    return `${x}% от ${y} = ${(x / 100 * y).toFixed(2)}`;
  }

  function calcNumberIsPercent(x, y) {
    return `${x} = ${(x / y * 100).toFixed(2)}% от ${y}`;
  }

  function calcNumberFromPercent(x, y) {
    const base = y / (x / 100);
    const sum = base + y;
    return `${x}% от ${base.toFixed(2)} = ${y}, сумма: ${sum.toFixed(2)}`;
  }

  function calcIncreaseByPercent(x, y) {
    return `${y} + ${x}% = ${((y * (100 + x)) / 100).toFixed(2)}`;
  }

  function calculate() {
    const x = parseFloat(xEl.value), y = parseFloat(yEl.value);
    if (isNaN(x) || isNaN(y)) {
      res.textContent = 'Введите оба значения';
      return;
    }
    if (modeEl.value === 'numberFromPercent' && x === 0) {
      res.textContent = 'Процент не может быть равен 0';
      return;
    }
    if (modeEl.value === 'numberIsPercent' && y === 0) {
      res.textContent = 'Деление на ноль невозможно';
      return;
    }
    let text = '';
    switch (modeEl.value) {
      case 'percentOfNumber': text = calcPercentOfNumber(x, y); break;
      case 'numberIsPercent': text = calcNumberIsPercent(x, y); break;
      case 'numberFromPercent': text = calcNumberFromPercent(x, y); break;
      case 'increaseByPercent': text = calcIncreaseByPercent(x, y); break;
    }
    res.textContent = text;
    addHistory(text);
    calcBeep.play();
  }

  btn.addEventListener('click', calculate);
  [xEl, yEl].forEach(el => 
    el.addEventListener('keypress', ev => ev.key === 'Enter' && calculate())
  );
  clearBtn.addEventListener('click', () => {
    historyArr = [];
    localStorage.removeItem('calcHistory');
    hist.innerHTML = '';
  });
  modeEl.addEventListener('change', updatePlaceholders);
  updatePlaceholders();

  // Валидация ввода в реальном времени
  [xEl, yEl, document.getElementById('minInput'), document.getElementById('secInput')].forEach(el => {
    el.addEventListener('input', () => {
      if (el.value < 0 && (el.id === 'minInput' || el.id === 'secInput')) {
        el.classList.add('invalid');
        res.textContent = 'Отрицательные значения недопустимы для таймера';
      } else {
        el.classList.remove('invalid');
        res.textContent = '';
      }
    });
  });

  // Сброс полей по Esc
  document.addEventListener('keydown', ev => {
    if (ev.key === 'Escape') {
      xEl.value = '';
      yEl.value = '';
      document.getElementById('minInput').value = '';
      document.getElementById('secInput').value = '';
      res.textContent = '';
    }
  });

  // ————— Компактное окно —————
  if (window.name === 'tinyCalc') openTiny.style.display = 'none';

  openTiny.addEventListener('click', () => {
    window.open(window.location.href, 'tinyCalc', 'width=300,height=500,left=100,top=100');
    openTiny.style.display = 'none';
  });

  // ————— Темная тема —————
  document.getElementById('toggleTheme').addEventListener('click', () => {
    document.body.classList.toggle('dark');
    document.querySelector('.calculator').classList.toggle('dark');
    document.querySelector('.history').classList.toggle('dark');
  });

  // ————— Таймер —————
  let timerInterval = null, total = 0, initialTotal = 0, isPaused = false;
  const display = document.getElementById('timerDisplay'),
        beep = document.getElementById('beep'),
        timerBtn = document.getElementById('timerBtn'),
        resetTimerBtn = document.getElementById('resetTimerBtn'),
        progressBar = document.getElementById('progressBar');

  function updateTimer() {
    total--;
    if (total < 0) {
      clearInterval(timerInterval);
      display.textContent = '00:00';
      display.classList.add('ending');
      beep.play();
      timerBtn.querySelector('span').textContent = 'Start Timer';
      timerInterval = null;
      isPaused = false;
      progressBar.style.setProperty('--progress', '0%');
    } else {
      const m = Math.floor(total / 60), s = total % 60;
      display.textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
      progressBar.style.setProperty('--progress', `${(total / initialTotal) * 100}%`);
      if (total < 10) display.classList.add('ending');
    }
  }

  timerBtn.addEventListener('click', () => {
    if (timerInterval && !isPaused) {
      clearInterval(timerInterval);
      timerBtn.querySelector('span').textContent = 'Resume Timer';
      isPaused = true;
      return;
    }
    if (isPaused) {
      timerInterval = setInterval(updateTimer, 1000);
      timerBtn.querySelector('span').textContent = 'Pause Timer';
      isPaused = false;
      return;
    }
    const mins = parseInt(document.getElementById('minInput').value) || 0;
    const secs = parseInt(document.getElementById('secInput').value) || 0;
    total = mins * 60 + secs;
    if (total <= 0) return alert('Установите время.');
    initialTotal = total;
    display.classList.remove('ending');
    timerBtn.querySelector('span').textContent = 'Pause Timer';
    timerInterval = setInterval(updateTimer, 1000);
    progressBar.style.setProperty('--progress', '100%');
  });

  resetTimerBtn.addEventListener('click', () => {
    clearInterval(timerInterval);
    timerInterval = null;
    total = 0;
    initialTotal = 0;
    isPaused = false;
    display.textContent = '00:00';
    display.classList.remove('ending');
    timerBtn.querySelector('span').textContent = 'Start Timer';
    document.getElementById('minInput').value = '';
    document.getElementById('secInput').value = '';
    progressBar.style.setProperty('--progress', '0%');
  });
</script>

</body>
</html>